<div class="config-overlay">
  <div class="config-container">
    <div class="config-header">
      <h2>{{ screenId === 'new' ? 'Create Screen' : 'Configure Screen' }}</h2>
      <button class="btn-close" (click)="close.emit()">‚úï</button>
    </div>

    @if (loading()) {
      <div class="loading">Loading configuration...</div>
    } @else {
      <div class="config-content">
        <div class="config-sidebar">
          <div class="form-section">
            <label>Screen Name</label>
            <input type="text" [value]="screenName()" (input)="screenName.set($any($event.target).value)" placeholder="Screen 1">
          </div>

          <div class="form-section compact">
            <label>Layout</label>
            <div class="dimension-row">
              <div class="dim-input">
                <span class="dim-label">Rows</span>
                <input type="number" [value]="rows()" (input)="rows.set(+$any($event.target).value)" min="1" max="26">
              </div>
              <span class="x-sep">√ó</span>
              <div class="dim-input">
                <span class="dim-label">Seats</span>
                <input type="number" [value]="seatsPerRow()" (input)="seatsPerRow.set(+$any($event.target).value)" min="1" max="30">
              </div>
              <button class="apply-btn" (click)="onDimensionChange()">Apply</button>
            </div>
          </div>

          <div class="form-section">
            <div class="section-header">
              <label>Mode</label>
            </div>
            <div class="mode-toggle">
              <button 
                class="mode-btn" 
                [class.active]="!disableMode()"
                (click)="disableMode.set(false)">
                üé® Assign Category
              </button>
              <button 
                class="mode-btn" 
                [class.active]="disableMode()"
                (click)="disableMode.set(true); selectedCategory.set(null)">
                üö´ Disable Seats
              </button>
            </div>
          </div>

          <div class="form-section" *ngIf="!disableMode()">
            <div class="section-header">
              <label>Categories</label>
              <button class="btn-add" (click)="toggleAddCategory()">{{ showAddCategory() ? '‚úï' : '+ Add' }}</button>
            </div>
            
            @if (showAddCategory()) {
              <div class="add-category-form">
                <input 
                  type="text" 
                  [value]="newCategoryName()" 
                  (input)="newCategoryName.set($any($event.target).value)" 
                  placeholder="Category name"
                  class="form-input">
                <div class="form-row">
                  <input 
                    type="number" 
                    [value]="newCategoryPrice()" 
                    (input)="newCategoryPrice.set(+$any($event.target).value)" 
                    placeholder="Price"
                    min="0"
                    class="form-input">
                  <input 
                    type="color" 
                    [value]="newCategoryColor()" 
                    (input)="newCategoryColor.set($any($event.target).value)" 
                    class="form-color">
                </div>
                <button class="btn-save-category" (click)="addCategory()">‚úì Add Category</button>
              </div>
            }
            
            @for (cat of sortedCategories(); track cat.id) {
              <div class="category-item" [class.selected]="selectedCategory() === cat.id" (click)="selectedCategory.set(cat.id)">
                <div class="cat-color" [style.background]="cat.color"></div>
                <div class="cat-info">
                  <span class="cat-name">{{ cat.name }}</span>
                  <span class="cat-price">‚Çπ{{ cat.price }}</span>
                </div>
                <button class="btn-remove" (click)="removeCategory(cat.id); $event.stopPropagation()">‚úï</button>
              </div>
            }
          </div>

          <div class="form-section" *ngIf="!disableMode() && selectedCategory()">
            <div class="quick-assign">
              <input type="text" [(ngModel)]="bulkRowRange" placeholder="Type: A-D or A,C,E">
              <button (click)="assignCategoryToBulkRows()">‚úì Apply</button>
            </div>
            <p class="hint">üí° Assign to multiple rows at once</p>
          </div>

          <div class="form-section">
            <p class="help-text"><strong>Instructions:</strong><br>
            @if (disableMode()) {
              ‚Ä¢ Click any seat to disable/enable it<br>
              ‚Ä¢ Click üö´ to toggle entire row<br>
            } @else {
              ‚Ä¢ Select a category above<br>
              ‚Ä¢ Click seat to assign category<br>
              ‚Ä¢ Click üé® to assign to entire row<br>
            }
            </p>
          </div>
        </div>

        <div class="config-preview">
          <div class="screen-indicator">
            <div class="screen-line"></div>
            <span>SCREEN</span>
          </div>

          <div class="seats-grid">
            @for (rowSeats of seatGrid(); track $index; let rowIdx = $index) {
              <div class="seat-row">
                <span class="row-label">{{ getRowLabel(rowIdx) }}</span>
                <button 
                  class="btn-assign-row" 
                  [class.disable-mode]="disableMode()"
                  (click)="assignCategoryToRow(rowIdx)" 
                  [title]="disableMode() ? 'Toggle entire row' : 'Assign category to entire row'">
                  {{ disableMode() ? 'üö´' : 'üé®' }}
                </button>
                <div class="seats">
                  @for (seat of rowSeats; track $index; let colIdx = $index) {
                    @if (seat) {
                      <button 
                        class="seat"
                        [class.disabled]="seat.status === 'disabled'"
                        [class.selected]="selectedCategory()"
                        [class.no-category]="!seat.categoryId && seat.status !== 'disabled'"
                        [style.background]="seat.status === 'disabled' ? '#94a3b8' : (getSeatCategory(seat)?.color || '#ffffff')"
                        (click)="onSeatClick(rowIdx, colIdx)"
                        [title]="seat.label + ' - ' + (seat.status === 'disabled' ? 'Disabled' : getSeatCategory(seat)?.name || 'No category')">
                        @if (seat.status === 'disabled') {
                          <span style="font-size: 14px;">‚ùå</span>
                        } @else {
                          {{ colIdx + 1 }}
                        }
                      </button>
                    } @else {
                      <div class="seat-gap"></div>
                    }
                  }
                </div>
                <span class="row-label">{{ getRowLabel(rowIdx) }}</span>
              </div>
            }
          </div>

          <div class="legend">
            @for (cat of sortedCategories(); track cat.id) {
              <div class="legend-item">
                <div class="legend-color" [style.background]="cat.color"></div>
                <span>{{ cat.name }}</span>
              </div>
            }
            <div class="legend-item">
              <div class="legend-color" style="background: #ccc"></div>
              <span>Disabled</span>
            </div>
          </div>
        </div>
      </div>

      <div class="config-footer">
        <button class="btn-secondary" (click)="close.emit()" [disabled]="saving()">Cancel</button>
        <button class="btn-primary" (click)="saveConfiguration()" [disabled]="saving()">
          {{ saving() ? 'Saving...' : 'Save Configuration' }}
        </button>
      </div>
    }
  </div>
</div>
