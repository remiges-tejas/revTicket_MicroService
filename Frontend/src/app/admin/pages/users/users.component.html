<div class="page-wrapper">
  <!-- HEADER -->
  <header class="page-header">
    <div class="header-left">
      <h1 class="page-title">ğŸ‘¥ Manage Users</h1>
      <p class="page-subtitle">{{ filteredUsers().length }} of {{ users().length }} users</p>
    </div>
  </header>

  <!-- FILTERS -->
  <section class="filters-bar">
    <div class="search-box">
      <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/>
        <path d="m21 21-4.35-4.35"/>
      </svg>
      <input 
        type="text" 
        class="search-input"
        placeholder="Search by name, email, or mobile..." 
        [value]="searchTerm()"
        (input)="onSearch($any($event.target).value)">
      @if (searchTerm()) {
      <button class="clear-btn" (click)="searchTerm.set(''); applyFilters()" title="Clear search">
        âœ•
      </button>
      }
    </div>
    
    <select class="filter-dropdown" [value]="roleFilter()" (change)="onRoleFilterChange($any($event.target).value)">
      <option value="ALL">ğŸ‘¤ All Roles</option>
      <option value="ADMIN">ğŸ”‘ Admin</option>
      <option value="USER">ğŸ‘¤ User</option>
    </select>

    <select class="filter-dropdown" [value]="statusFilter()" (change)="onStatusFilterChange($any($event.target).value)">
      <option value="ALL">ğŸ”˜ All Status</option>
      <option value="ACTIVE">âœ… Active</option>
      <option value="BLOCKED">âŒ Blocked</option>
    </select>

    @if (searchTerm() || roleFilter() !== 'ALL' || statusFilter() !== 'ALL') {
    <button class="btn-clear-filters" (click)="searchTerm.set(''); roleFilter.set('ALL'); statusFilter.set('ALL'); applyFilters()">
      <span>ğŸ”„</span>
      <span>Clear</span>
    </button>
    }
  </section>

  <!-- LOADING -->
  @if (loading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Loading users...</p>
    </div>
  }

  <!-- EMPTY STATE -->
  @else if (filteredUsers().length === 0) {
    <div class="empty-state">
      <div class="empty-icon">ğŸ‘¥</div>
      <h3>No Users Found</h3>
      @if (searchTerm() || roleFilter() !== 'ALL' || statusFilter() !== 'ALL') {
        <p>No users match your current filters</p>
        <button class="btn-clear-filters" (click)="searchTerm.set(''); roleFilter.set('ALL'); statusFilter.set('ALL'); applyFilters()">
          <span>ğŸ”„</span>
          <span>Clear All Filters</span>
        </button>
      } @else {
        <p>No users registered yet</p>
      }
    </div>
  }

  <!-- USERS TABLE -->
  @else {
    <div class="users-table">
      <div class="table-header">
        <div class="col-name" (click)="onSortChange('name')">
          Name {{ sortBy() === 'name' ? (sortOrder() === 'asc' ? 'â†‘' : 'â†“') : '' }}
        </div>
        <div class="col-email" (click)="onSortChange('email')">
          Email {{ sortBy() === 'email' ? (sortOrder() === 'asc' ? 'â†‘' : 'â†“') : '' }}
        </div>
        <div class="col-mobile">Mobile</div>
        <div class="col-role">Role</div>
        <div class="col-status">Status</div>
        <div class="col-joined" (click)="onSortChange('createdAt')">
          Joined {{ sortBy() === 'createdAt' ? (sortOrder() === 'asc' ? 'â†‘' : 'â†“') : '' }}
        </div>
        <div class="col-actions">Actions</div>
      </div>

      @for (user of filteredUsers(); track user.id) {
        <div class="table-row">
          <div class="col-name">
            <div class="user-info">
              <div class="user-avatar">{{ (user.name || 'U').charAt(0).toUpperCase() }}</div>
              <span class="user-name">{{ user.name }}</span>
            </div>
          </div>
          <div class="col-email">{{ user.email }}</div>
          <div class="col-mobile">{{ user.phone || 'N/A' }}</div>
          <div class="col-role">
            <select 
              class="role-select"
              [value]="user.role"
              (change)="changeUserRole(user, $any($event.target).value)"
              [disabled]="updatingRoleId() === user.id"
              [class.admin]="user.role === 'ADMIN'"
              [class.user]="user.role === 'USER'">
              <option value="USER">ğŸ‘¤ USER</option>
              <option value="ADMIN">ğŸ”‘ ADMIN</option>
            </select>
          </div>
          <div class="col-status">
            <span class="status-badge" [class.active]="user.isActive !== false" [class.inactive]="user.isActive === false">
              {{ user.isActive !== false ? 'âœ… Active' : 'âŒ Blocked' }}
            </span>
          </div>
          <div class="col-joined">
            <span class="date-text">ğŸ“… {{ user.createdAt | date:'MMM d, y' }}</span>
          </div>
          <div class="col-actions">
            <button class="action-btn view" (click)="viewUser(user)" title="View details">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
            </button>

            <button class="action-btn disable" (click)="toggleUserStatus(user)" [title]="user.isActive !== false ? 'Disable user' : 'Enable user'">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/>
              </svg>
            </button>
            <button class="action-btn delete" (click)="deleteUser(user)" title="Delete user">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
              </svg>
            </button>
          </div>
        </div>
      }
    </div>
  }
</div>

<!-- VIEW MODAL -->
@if (showViewModal()) {
  <div class="modal-overlay" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>User Details</h2>
        <button class="btn-close" (click)="closeModal()">âœ•</button>
      </div>
      
      @if (selectedUser(); as user) {
        <div class="modal-body">
          <div class="user-details">
            <div class="detail-row">
              <span class="label">Name:</span>
              <span class="value">{{ user.name }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Email:</span>
              <span class="value">{{ user.email }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Mobile:</span>
              <span class="value">{{ user.phone || 'N/A' }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Role:</span>
              <span class="role-badge" [class.admin]="user.role === 'ADMIN'" [class.user]="user.role === 'USER'">{{ user.role }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Status:</span>
              <span class="status-badge" [class.active]="user.isActive !== false" [class.blocked]="user.isActive === false">
                {{ user.isActive !== false ? 'ACTIVE' : 'BLOCKED' }}
              </span>
            </div>
            <div class="detail-row">
              <span class="label">Joined:</span>
              <span class="value">{{ user.createdAt | date:'MMM d, y, h:mm a' }}</span>
            </div>
          </div>

          <div class="bookings-section">
            <h3>Recent Bookings</h3>
            @if (loadingBookings()) {
              <div class="loading-bookings">
                <div class="spinner-small"></div>
                <p>Loading...</p>
              </div>
            } @else if (userBookings().length === 0) {
              <p class="no-bookings">No bookings found</p>
            } @else {
              <div class="bookings-list">
                @for (booking of userBookings(); track booking.id) {
                  <div class="booking-item">
                    <div class="booking-info">
                      <strong>{{ booking.movieTitle }}</strong>
                      <span>{{ booking.theaterName }}</span>
                      <span>{{ booking.showDate | date:'MMM d, y' }} at {{ booking.showTime }}</span>
                    </div>
                    <div class="booking-meta">
                      <span class="amount">â‚¹{{ booking.totalAmount }}</span>
                      <span class="status" [class]="booking.status.toLowerCase()">{{ booking.status }}</span>
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        </div>
      }
    </div>
  </div>
}


